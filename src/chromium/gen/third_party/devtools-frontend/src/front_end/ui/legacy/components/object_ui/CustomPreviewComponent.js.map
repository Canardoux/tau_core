{
  "version": 3,
  "sources": ["../../../../../../../../../../../third_party/devtools-frontend/src/front_end/ui/legacy/components/object_ui/CustomPreviewComponent.ts"],
  "sourcesContent": ["// Copyright 2014 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../../core/common/common.js';\nimport * as i18n from '../../../../core/i18n/i18n.js';\nimport type * as SDK from '../../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../../generated/protocol.js';\nimport * as IconButton from '../../../components/icon_button/icon_button.js';\nimport * as UI from '../../legacy.js';\n\nimport customPreviewComponentStyles from './customPreviewComponent.css.js';\nimport {\n  ObjectPropertiesSection,\n  ObjectPropertiesSectionsTreeOutline,\n  ObjectPropertyTreeElement,\n} from './ObjectPropertiesSection.js';\n\nconst UIStrings = {\n  /**\n   *@description A context menu item in the Custom Preview Component\n   */\n  showAsJavascriptObject: 'Show as JavaScript object',\n};\nconst str_ = i18n.i18n.registerUIStrings('ui/legacy/components/object_ui/CustomPreviewComponent.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport class CustomPreviewSection {\n  private readonly sectionElement: HTMLSpanElement;\n  private readonly object: SDK.RemoteObject.RemoteObject;\n  private expanded: boolean;\n  private cachedContent: Node|null;\n  private readonly header: Node|undefined;\n  private readonly expandIcon: IconButton.Icon.Icon|undefined;\n  constructor(object: SDK.RemoteObject.RemoteObject) {\n    this.sectionElement = document.createElement('span');\n    this.sectionElement.classList.add('custom-expandable-section');\n    this.object = object;\n    this.expanded = false;\n    this.cachedContent = null;\n    const customPreview = object.customPreview();\n\n    if (!customPreview) {\n      return;\n    }\n\n    let headerJSON;\n    try {\n      headerJSON = JSON.parse(customPreview.header);\n    } catch (e) {\n      Common.Console.Console.instance().error('Broken formatter: header is invalid json ' + e);\n      return;\n    }\n    this.header = this.renderJSONMLTag(headerJSON);\n    if (this.header.nodeType === Node.TEXT_NODE) {\n      Common.Console.Console.instance().error('Broken formatter: header should be an element node.');\n      return;\n    }\n\n    if (customPreview.bodyGetterId) {\n      if (this.header instanceof Element) {\n        this.header.classList.add('custom-expandable-section-header');\n      }\n      this.header.addEventListener('click', this.onClick.bind(this), false);\n      this.expandIcon = IconButton.Icon.create('triangle-right', 'custom-expand-icon');\n      this.header.insertBefore(this.expandIcon, this.header.firstChild);\n    }\n\n    this.sectionElement.appendChild(this.header);\n  }\n\n  element(): Element {\n    return this.sectionElement;\n  }\n\n  private renderJSONMLTag(jsonML: unknown): Node {\n    if (!Array.isArray(jsonML)) {\n      return document.createTextNode(String(jsonML));\n    }\n\n    return jsonML[0] === 'object' ? this.layoutObjectTag(jsonML) : this.renderElement(jsonML);\n  }\n\n  // TODO(crbug.com/1172300) Ignored during the jsdoc to ts migration)\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  private renderElement(object: any[]): Node {\n    const tagName = object.shift();\n    if (!ALLOWED_TAGS.includes(tagName)) {\n      Common.Console.Console.instance().error('Broken formatter: element ' + tagName + ' is not allowed!');\n      return document.createElement('span');\n    }\n    const element = document.createElement((tagName as string));\n    if ((typeof object[0] === 'object') && !Array.isArray(object[0])) {\n      const attributes = object.shift();\n      for (const key in attributes) {\n        const value = attributes[key];\n        if ((key !== 'style') || (typeof value !== 'string')) {\n          continue;\n        }\n\n        element.setAttribute(key, value);\n      }\n    }\n\n    this.appendJsonMLTags(element, object);\n    return element;\n  }\n\n  private layoutObjectTag(objectTag: unknown[]): Node {\n    objectTag.shift();\n    const attributes = objectTag.shift();\n    const remoteObject = this.object.runtimeModel().createRemoteObject((attributes as Protocol.Runtime.RemoteObject));\n    if (remoteObject.customPreview()) {\n      return (new CustomPreviewSection(remoteObject)).element();\n    }\n\n    const sectionElement = ObjectPropertiesSection.defaultObjectPresentation(remoteObject);\n    sectionElement.classList.toggle('custom-expandable-section-standard-section', remoteObject.hasChildren);\n    return sectionElement;\n  }\n\n  private appendJsonMLTags(parentElement: Node, jsonMLTags: unknown[]): void {\n    for (let i = 0; i < jsonMLTags.length; ++i) {\n      parentElement.appendChild(this.renderJSONMLTag(jsonMLTags[i]));\n    }\n  }\n\n  private onClick(event: Event): void {\n    event.consume(true);\n    if (this.cachedContent) {\n      this.toggleExpand();\n    } else {\n      void this.loadBody();\n    }\n  }\n\n  private toggleExpand(): void {\n    this.expanded = !this.expanded;\n    if (this.header instanceof Element) {\n      this.header.classList.toggle('expanded', this.expanded);\n    }\n    if (this.cachedContent instanceof Element) {\n      this.cachedContent.classList.toggle('hidden', !this.expanded);\n    }\n    if (this.expandIcon) {\n      if (this.expanded) {\n        this.expandIcon.name = 'triangle-down';\n      } else {\n        this.expandIcon.name = 'triangle-right';\n      }\n    }\n  }\n  private defaultBodyTreeOutline: ObjectPropertiesSectionsTreeOutline|undefined;\n\n  async loadBody(): Promise<void> {\n    const customPreview = this.object.customPreview();\n\n    if (!customPreview) {\n      return;\n    }\n\n    if (customPreview.bodyGetterId) {\n      const bodyJsonML =\n          await this.object.callFunctionJSON(bodyGetter => bodyGetter(), [{objectId: customPreview.bodyGetterId}]);\n      if (bodyJsonML === null) {\n        // Per https://firefox-source-docs.mozilla.org/devtools-user/custom_formatters/index.html#custom-formatter-structure\n        // we are supposed to fall back to the default format when the `body()` callback returns `null`.\n        this.defaultBodyTreeOutline = new ObjectPropertiesSectionsTreeOutline({readOnly: true});\n        this.defaultBodyTreeOutline.setShowSelectionOnKeyboardFocus(/* show */ true, /* preventTabOrder */ false);\n        this.defaultBodyTreeOutline.element.classList.add('custom-expandable-section-default-body');\n        void ObjectPropertyTreeElement.populate(this.defaultBodyTreeOutline.rootElement(), this.object, false, false);\n\n        this.cachedContent = this.defaultBodyTreeOutline.element;\n      } else {\n        this.cachedContent = this.renderJSONMLTag(bodyJsonML);\n      }\n\n      this.sectionElement.appendChild(this.cachedContent);\n      this.toggleExpand();\n    }\n  }\n}\n\nconst ALLOWED_TAGS = ['span', 'div', 'ol', 'li', 'table', 'tr', 'td'];\n\nexport class CustomPreviewComponent {\n  private readonly object: SDK.RemoteObject.RemoteObject;\n  private customPreviewSection: CustomPreviewSection|null;\n  element: HTMLSpanElement;\n  constructor(object: SDK.RemoteObject.RemoteObject) {\n    this.object = object;\n    this.customPreviewSection = new CustomPreviewSection(object);\n    this.element = document.createElement('span');\n    this.element.classList.add('source-code');\n    const shadowRoot = UI.UIUtils.createShadowRootWithCoreStyles(this.element, {\n      cssFile: [customPreviewComponentStyles],\n      delegatesFocus: undefined,\n    });\n    this.element.addEventListener('contextmenu', this.contextMenuEventFired.bind(this), false);\n    shadowRoot.appendChild(this.customPreviewSection.element());\n  }\n\n  expandIfPossible(): void {\n    const customPreview = this.object.customPreview();\n    if (customPreview && customPreview.bodyGetterId && this.customPreviewSection) {\n      void this.customPreviewSection.loadBody();\n    }\n  }\n\n  private contextMenuEventFired(event: Event): void {\n    const contextMenu = new UI.ContextMenu.ContextMenu(event);\n    if (this.customPreviewSection) {\n      contextMenu.revealSection().appendItem(\n          i18nString(UIStrings.showAsJavascriptObject), this.disassemble.bind(this),\n          {jslogContext: 'show-as-javascript-object'});\n    }\n    contextMenu.appendApplicableItems(this.object);\n    void contextMenu.show();\n  }\n\n  private disassemble(): void {\n    if (this.element.shadowRoot) {\n      this.element.shadowRoot.textContent = '';\n      this.customPreviewSection = null;\n      this.element.shadowRoot.appendChild(ObjectPropertiesSection.defaultObjectPresentation(this.object));\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
