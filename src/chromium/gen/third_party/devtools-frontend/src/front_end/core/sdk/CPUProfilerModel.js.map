{
  "version": 3,
  "sources": ["../../../../../../../../../third_party/devtools-frontend/src/front_end/core/sdk/CPUProfilerModel.ts"],
  "sourcesContent": ["/*\n * Copyright (C) 2014 Google Inc. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are\n * met:\n *\n *     * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n *     * Redistributions in binary form must reproduce the above\n * copyright notice, this list of conditions and the following disclaimer\n * in the documentation and/or other materials provided with the\n * distribution.\n *     * Neither the name of Google Inc. nor the names of its\n * contributors may be used to endorse or promote products derived from\n * this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport type * as ProtocolProxyApi from '../../generated/protocol-proxy-api.js';\nimport type * as Protocol from '../../generated/protocol.js';\nimport * as i18n from '../i18n/i18n.js';\n\nimport {DebuggerModel, Location} from './DebuggerModel.js';\nimport type {RuntimeModel} from './RuntimeModel.js';\nimport {SDKModel} from './SDKModel.js';\nimport {Capability, type Target} from './Target.js';\n\nconst UIStrings = {\n  /**\n   *@description Name of a profile. Placeholder is either a user-supplied name or a number automatically assigned to the profile.\n   *@example {2} PH1\n   */\n  profileD: 'Profile {PH1}',\n};\nconst str_ = i18n.i18n.registerUIStrings('core/sdk/CPUProfilerModel.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport class CPUProfilerModel extends SDKModel<EventTypes> implements ProtocolProxyApi.ProfilerDispatcher {\n  #isRecording: boolean;\n  #nextAnonymousConsoleProfileNumber: number;\n  #anonymousConsoleProfileIdToTitle: Map<string, string>;\n  readonly #profilerAgent: ProtocolProxyApi.ProfilerApi;\n  #preciseCoverageDeltaUpdateCallback:\n      ((arg0: number, arg1: string, arg2: Array<Protocol.Profiler.ScriptCoverage>) => Promise<void>)|null;\n  readonly #debuggerModelInternal: DebuggerModel;\n  readonly registeredConsoleProfileMessages: ProfileFinishedData[] = [];\n\n  constructor(target: Target) {\n    super(target);\n    this.#isRecording = false;\n    this.#nextAnonymousConsoleProfileNumber = 1;\n    this.#anonymousConsoleProfileIdToTitle = new Map();\n    this.#profilerAgent = target.profilerAgent();\n    this.#preciseCoverageDeltaUpdateCallback = null;\n    target.registerProfilerDispatcher(this);\n    void this.#profilerAgent.invoke_enable();\n    this.#debuggerModelInternal = (target.model(DebuggerModel) as DebuggerModel);\n  }\n\n  runtimeModel(): RuntimeModel {\n    return this.#debuggerModelInternal.runtimeModel();\n  }\n\n  debuggerModel(): DebuggerModel {\n    return this.#debuggerModelInternal;\n  }\n\n  consoleProfileStarted({id, location, title}: Protocol.Profiler.ConsoleProfileStartedEvent): void {\n    if (!title) {\n      title = i18nString(UIStrings.profileD, {PH1: this.#nextAnonymousConsoleProfileNumber++});\n      this.#anonymousConsoleProfileIdToTitle.set(id, title);\n    }\n    const eventData = this.createEventDataFrom(id, location, title);\n    this.dispatchEventToListeners(Events.CONSOLE_PROFILE_STARTED, eventData);\n  }\n\n  consoleProfileFinished({id, location, profile, title}: Protocol.Profiler.ConsoleProfileFinishedEvent): void {\n    if (!title) {\n      title = this.#anonymousConsoleProfileIdToTitle.get(id);\n      this.#anonymousConsoleProfileIdToTitle.delete(id);\n    }\n    const eventData: ProfileFinishedData = {\n      ...this.createEventDataFrom(id, location, title),\n      cpuProfile: profile,\n    };\n    this.registeredConsoleProfileMessages.push(eventData);\n    this.dispatchEventToListeners(Events.CONSOLE_PROFILE_FINISHED, eventData);\n  }\n\n  private createEventDataFrom(id: string, scriptLocation: Protocol.Debugger.Location, title?: string): EventData {\n    const debuggerLocation = Location.fromPayload(this.#debuggerModelInternal, scriptLocation);\n    const globalId = this.target().id() + '.' + id;\n    return {\n      id: globalId,\n      scriptLocation: debuggerLocation,\n      title: title || '',\n      cpuProfilerModel: this,\n    };\n  }\n\n  isRecordingProfile(): boolean {\n    return this.#isRecording;\n  }\n\n  startRecording(): Promise<unknown> {\n    this.#isRecording = true;\n    const intervalUs = 100;\n    void this.#profilerAgent.invoke_setSamplingInterval({interval: intervalUs});\n    return this.#profilerAgent.invoke_start();\n  }\n\n  stopRecording(): Promise<Protocol.Profiler.Profile|null> {\n    this.#isRecording = false;\n    return this.#profilerAgent.invoke_stop().then(response => response.profile || null);\n  }\n\n  startPreciseCoverage(\n      jsCoveragePerBlock: boolean,\n      preciseCoverageDeltaUpdateCallback:\n          ((arg0: number, arg1: string, arg2: Array<Protocol.Profiler.ScriptCoverage>) => Promise<void>)|\n      null): Promise<unknown> {\n    const callCount = false;\n    this.#preciseCoverageDeltaUpdateCallback = preciseCoverageDeltaUpdateCallback;\n    const allowUpdatesTriggeredByBackend = true;\n    return this.#profilerAgent.invoke_startPreciseCoverage(\n        {callCount, detailed: jsCoveragePerBlock, allowTriggeredUpdates: allowUpdatesTriggeredByBackend});\n  }\n\n  async takePreciseCoverage(): Promise<{\n    timestamp: number,\n    coverage: Array<Protocol.Profiler.ScriptCoverage>,\n  }> {\n    const r = await this.#profilerAgent.invoke_takePreciseCoverage();\n    const timestamp = (r && r.timestamp) || 0;\n    const coverage = (r && r.result) || [];\n    return {timestamp, coverage};\n  }\n\n  stopPreciseCoverage(): Promise<unknown> {\n    this.#preciseCoverageDeltaUpdateCallback = null;\n    return this.#profilerAgent.invoke_stopPreciseCoverage();\n  }\n\n  preciseCoverageDeltaUpdate({timestamp, occasion, result}: Protocol.Profiler.PreciseCoverageDeltaUpdateEvent): void {\n    if (this.#preciseCoverageDeltaUpdateCallback) {\n      void this.#preciseCoverageDeltaUpdateCallback(timestamp, occasion, result);\n    }\n  }\n}\n\nexport const enum Events {\n  CONSOLE_PROFILE_STARTED = 'ConsoleProfileStarted',\n  CONSOLE_PROFILE_FINISHED = 'ConsoleProfileFinished',\n}\n\nexport type EventTypes = {\n  [Events.CONSOLE_PROFILE_STARTED]: EventData,\n  [Events.CONSOLE_PROFILE_FINISHED]: ProfileFinishedData,\n};\n\nSDKModel.register(CPUProfilerModel, {capabilities: Capability.JS, autostart: true});\n\nexport interface EventData {\n  id: string;\n  scriptLocation: Location;\n  title: string;\n  cpuProfilerModel: CPUProfilerModel;\n}\n\nexport interface ProfileFinishedData extends EventData {\n  cpuProfile: Protocol.Profiler.Profile;\n}\n"],
  "mappings": "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",
  "names": ["Events"]
}
